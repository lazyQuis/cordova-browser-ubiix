function Janus(e){function n(){if(null!=F)if(Janus.debug("Long poll..."),P){var r=O+"/"+F+"?rid="+(new Date).getTime();void 0!==E&&null!==E&&(r=r+"&maxev="+E),null!==L&&void 0!==L&&(r=r+"&token="+L),null!==V&&void 0!==V&&(r=r+"&apisecret="+V),Janus.ajax({type:"GET",url:r,withCredentials:M,cache:!1,timeout:6e4,success:t,error:function(t,r,o){if(Janus.error(r+": "+o),++G>3)return P=!1,void e.error("Lost connection to the gateway (is it down?)");n()},dataType:"json"})}else Janus.warn("Is the gateway down? (connected=false)")}function t(e,r){if(G=0,k||void 0===F||null===F||!0===r||setTimeout(n,200),k||!Array.isArray(e))if("keepalive"!==e.janus)if("ack"!==e.janus)if("success"!==e.janus){if("webrtcup"===e.janus){Janus.debug("Got a webrtcup event on session "+F),Janus.debug(e);if(void 0===(o=e.sender)||null===o)return void Janus.warn("Missing sender...");return void 0===(i=U[o])||null===i?void Janus.debug("This handle is not attached to this session"):void i.webrtcState(!0)}if("hangup"===e.janus){Janus.debug("Got a hangup event on session "+F),Janus.debug(e);if(void 0===(o=e.sender)||null===o)return void Janus.warn("Missing sender...");if(void 0===(i=U[o])||null===i)return void Janus.debug("This handle is not attached to this session");i.webrtcState(!1,e.reason),i.hangup()}else if("detached"===e.janus){Janus.debug("Got a detached event on session "+F),Janus.debug(e);if(void 0===(o=e.sender)||null===o)return void Janus.warn("Missing sender...");if(void 0===(i=U[o])||null===i)return;i.detached=!0,i.ondetached(),i.detach()}else if("media"===e.janus){Janus.debug("Got a media event on session "+F),Janus.debug(e);if(void 0===(o=e.sender)||null===o)return void Janus.warn("Missing sender...");if(void 0===(i=U[o])||null===i)return void Janus.debug("This handle is not attached to this session");i.mediaState(e.type,e.receiving)}else if("slowlink"===e.janus){Janus.debug("Got a slowlink event on session "+F),Janus.debug(e);if(void 0===(o=e.sender)||null===o)return void Janus.warn("Missing sender...");if(void 0===(i=U[o])||null===i)return void Janus.debug("This handle is not attached to this session");i.slowLink(e.uplink,e.nacks)}else{if("error"===e.janus){Janus.error("Ooops: "+e.error.code+" "+e.error.reason),Janus.debug(e);d=e.transaction;if(null!==d&&void 0!==d){c=H[d];null!==c&&void 0!==c&&c(e),delete H[d]}return}if("event"===e.janus){Janus.debug("Got a plugin event on session "+F),Janus.debug(e);var o=e.sender;if(void 0===o||null===o)return void Janus.warn("Missing sender...");var a=e.plugindata;if(void 0===a||null===a)return void Janus.warn("Missing plugindata...");Janus.debug("  -- Event is coming from "+o+" ("+a.plugin+")");var s=a.data;Janus.debug(s);var i=U[o];if(void 0===i||null===i)return void Janus.warn("This handle is not attached to this session");var u=e.jsep;void 0!==u&&null!==u&&(Janus.debug("Handling SDP as well..."),Janus.debug(u));var l=i.onmessage;null!==l&&void 0!==l?(Janus.debug("Notifying application..."),l(s,u)):Janus.debug("No provided notification callback")}else Janus.warn("Unkown message/event  '"+e.janus+"' on session "+F),Janus.debug(e)}}else{Janus.debug("Got a success on session "+F),Janus.debug(e);if(null!==(d=e.transaction)&&void 0!==d){null!==(c=H[d])&&void 0!==c&&c(e),delete H[d]}}else{Janus.debug("Got an ack on session "+F),Janus.debug(e);var d;if(null!==(d=e.transaction)&&void 0!==d){var c;null!==(c=H[d])&&void 0!==c&&c(e),delete H[d]}}else Janus.vdebug("Got a keepalive on session "+F);else for(var f=0;f<e.length;f++)t(e[f],!0)}function r(){if(null!==O&&k&&P){C=setTimeout(r,3e4);var e={janus:"keepalive",session_id:F,transaction:Janus.randomString(12)};null!==L&&void 0!==L&&(e.token=L),null!==V&&void 0!==V&&(e.apisecret=V),T.send(JSON.stringify(e))}}function o(a){var s=Janus.randomString(12),i={janus:"create",transaction:s};if(null!==L&&void 0!==L&&(i.token=L),null!==V&&void 0!==V&&(i.apisecret=V),null===O&&Array.isArray(j)&&(0===(O=j[R]).indexOf("ws")?(k=!0,Janus.log("Server #"+(R+1)+": trying WebSockets to contact Janus ("+O+")")):(k=!1,Janus.log("Server #"+(R+1)+": trying REST API to contact Janus ("+O+")"))),k){T=new WebSocket(O,"janus-protocol"),D={error:function(){if(Janus.error("Error connecting to the Janus WebSockets server... "+O),Array.isArray(j))return++R==j.length?void a.error("Error connecting to any of the provided Janus servers: Is the gateway down?"):(O=null,void setTimeout(function(){o(a)},200));a.error("Error connecting to the Janus WebSockets server: Is the gateway down?")},open:function(){H[s]=function(e){if(Janus.debug(e),"success"!==e.janus)return Janus.error("Ooops: "+e.error.code+" "+e.error.reason),void a.error(e.error.reason);C=setTimeout(r,3e4),P=!0,F=e.data.id,Janus.log("Created session: "+F),Janus.sessions[F]=q,a.success()},T.send(JSON.stringify(i))},message:function(e){try{t(JSON.parse(e.data))}catch(e){Janus.error("Error processing event:",e)}},close:function(){null!==O&&P&&(P=!1,e.error("Lost connection to the gateway (is it down?)"))}};for(var u in D)T.addEventListener(u,D[u])}else Janus.ajax({type:"POST",url:O,withCredentials:M,cache:!1,contentType:"application/json",data:JSON.stringify(i),success:function(e){if(Janus.debug(e),"success"!==e.janus)return Janus.error("Ooops: "+e.error.code+" "+e.error.reason),void a.error(e.error.reason);P=!0,F=e.data.id,Janus.log("Created session: "+F),Janus.sessions[F]=q,n(),a.success()},error:function(e,n,t){if(Janus.error(n+": "+t),Array.isArray(j))return++R==j.length?void a.error("Error connecting to any of the provided Janus servers: Is the gateway down?"):(O=null,void setTimeout(function(){o(a)},200));""===t?a.error(n+": Is the gateway down?"):a.error(n+": "+t)},dataType:"json"})}function a(e,n){if(n=n||{},n.success="function"==typeof n.success?n.success:Janus.noop,n.error="function"==typeof n.error?n.error:Janus.noop,!P)return Janus.warn("Is the gateway down? (connected=false)"),void n.error("Is the gateway down? (connected=false)");var t=n.message,r=n.jsep,o=Janus.randomString(12),a={janus:"message",body:t,transaction:o};if(null!==L&&void 0!==L&&(a.token=L),null!==V&&void 0!==V&&(a.apisecret=V),null!==r&&void 0!==r&&(a.jsep=r),Janus.debug("Sending message to plugin (handle="+e+"):"),Janus.debug(a),k)return a.session_id=F,a.handle_id=e,H[o]=function(e){if(Janus.debug("Message sent!"),Janus.debug(e),"success"===e.janus){var t=e.plugindata;if(void 0===t||null===t)return Janus.warn("Request succeeded, but missing plugindata..."),void n.success();Janus.log("Synchronous transaction successful ("+t.plugin+")");var r=t.data;return Janus.debug(r),void n.success(r)}"ack"===e.janus?n.success():void 0!==e.error&&null!==e.error?(Janus.error("Ooops: "+e.error.code+" "+e.error.reason),n.error(e.error.code+" "+e.error.reason)):(Janus.error("Unknown error"),n.error("Unknown error"))},void T.send(JSON.stringify(a));Janus.ajax({type:"POST",url:O+"/"+F+"/"+e,withCredentials:M,cache:!1,contentType:"application/json",data:JSON.stringify(a),success:function(e){if(Janus.debug("Message sent!"),Janus.debug(e),"success"===e.janus){var t=e.plugindata;if(void 0===t||null===t)return Janus.warn("Request succeeded, but missing plugindata..."),void n.success();Janus.log("Synchronous transaction successful ("+t.plugin+")");var r=t.data;return Janus.debug(r),void n.success(r)}"ack"===e.janus?n.success():void 0!==e.error&&null!==e.error?(Janus.error("Ooops: "+e.error.code+" "+e.error.reason),n.error(e.error.code+" "+e.error.reason)):(Janus.error("Unknown error"),n.error("Unknown error"))},error:function(e,t,r){Janus.error(t+": "+r),n.error(t+": "+r)},dataType:"json"})}function s(e,n){if(P){var t={janus:"trickle",candidate:n,transaction:Janus.randomString(12)};if(null!==L&&void 0!==L&&(t.token=L),null!==V&&void 0!==V&&(t.apisecret=V),Janus.vdebug("Sending trickle candidate (handle="+e+"):"),Janus.vdebug(t),k)return t.session_id=F,t.handle_id=e,void T.send(JSON.stringify(t));Janus.ajax({type:"POST",url:O+"/"+F+"/"+e,withCredentials:M,cache:!1,contentType:"application/json",data:JSON.stringify(t),success:function(e){Janus.vdebug("Candidate sent!"),Janus.vdebug(e),"ack"===e.janus||Janus.error("Ooops: "+e.error.code+" "+e.error.reason)},error:function(e,n,t){Janus.error(n+": "+t)},dataType:"json"})}else Janus.warn("Is the gateway down? (connected=false)")}function i(e,n){(n=n||{}).success="function"==typeof n.success?n.success:Janus.noop,n.error="function"==typeof n.error?n.error:Janus.noop;var t=U[e];if(null===t||void 0===t||null===t.webrtcStuff||void 0===t.webrtcStuff)return Janus.warn("Invalid handle"),void n.error("Invalid handle");var r=t.webrtcStuff,o=n.text;if(null===o||void 0===o)return Janus.warn("Invalid text"),void n.error("Invalid text");Janus.log("Sending string on data channel: "+o),r.dataChannel.send(o),n.success()}function u(e,n){(n=n||{}).success="function"==typeof n.success?n.success:Janus.noop,n.error="function"==typeof n.error?n.error:Janus.noop;var t=U[e];if(null===t||void 0===t||null===t.webrtcStuff||void 0===t.webrtcStuff)return Janus.warn("Invalid handle"),void n.error("Invalid handle");var r=t.webrtcStuff;if(null===r.dtmfSender||void 0===r.dtmfSender){if(void 0!==r.myStream&&null!==r.myStream){var o=r.myStream.getAudioTracks();if(null!==o&&void 0!==o&&o.length>0){var a=o[0];r.dtmfSender=r.pc.createDTMFSender(a),Janus.log("Created DTMF Sender"),r.dtmfSender.ontonechange=function(e){Janus.debug("Sent DTMF tone: "+e.tone)}}}if(null===r.dtmfSender||void 0===r.dtmfSender)return Janus.warn("Invalid DTMF configuration"),void n.error("Invalid DTMF configuration")}var s=n.dtmf;if(null===s||void 0===s)return Janus.warn("Invalid DTMF parameters"),void n.error("Invalid DTMF parameters");var i=s.tones;if(null===i||void 0===i)return Janus.warn("Invalid DTMF string"),void n.error("Invalid DTMF string");var u=s.duration;null!==u&&void 0!==u||(u=500);var l=s.gap;null!==l&&void 0!==l||(l=50),Janus.debug("Sending DTMF string "+i+" (duration "+u+"ms, gap "+l+"ms)"),r.dtmfSender.insertDTMF(i,u,l)}function l(e,n){(n=n||{}).success="function"==typeof n.success?n.success:Janus.noop,n.error="function"==typeof n.error?n.error:Janus.noop;var t=!0;if(void 0!==n.asyncRequest&&null!==n.asyncRequest&&(t=!0===n.asyncRequest),Janus.log("Destroying handle "+e+" (sync="+t+")"),w(e),U[e].detached)return delete U[e],void n.success();if(!P)return Janus.warn("Is the gateway down? (connected=false)"),void n.error("Is the gateway down? (connected=false)");var r={janus:"detach",transaction:Janus.randomString(12)};if(null!==L&&void 0!==L&&(r.token=L),null!==V&&void 0!==V&&(r.apisecret=V),k)return r.session_id=F,r.handle_id=e,T.send(JSON.stringify(r)),delete U[e],void n.success();Janus.ajax({type:"POST",url:O+"/"+F+"/"+e,async:t,withCredentials:M,cache:!1,contentType:"application/json",data:JSON.stringify(r),success:function(t){Janus.log("Destroyed handle:"),Janus.debug(t),"success"!==t.janus&&Janus.error("Ooops: "+t.error.code+" "+t.error.reason),delete U[e],n.success()},error:function(t,r,o){Janus.error(r+": "+o),delete U[e],n.success()},dataType:"json"})}function d(e,n,t,r,o){var a=U[e];if(null===a||void 0===a||null===a.webrtcStuff||void 0===a.webrtcStuff)return Janus.warn("Invalid handle"),void r.error("Invalid handle");var i=a.webrtcStuff;Janus.debug("streamsDone:",o),i.myStream=o;var u={iceServers:x,iceTransportPolicy:A},l={optional:[{DtlsSrtpKeyAgreement:!0}]};if(!0===N&&l.optional.push({googIPv6:!0}),"edge"===adapter.browserDetails.browser&&(u.bundlePolicy="max-bundle"),Janus.log("Creating PeerConnection"),Janus.debug(l),i.pc=new RTCPeerConnection(u,l),Janus.debug(i.pc),i.pc.getStats&&(i.volume.value=0,i.bitrate.value="0 kbits/sec"),Janus.log("Preparing local SDP and gathering candidates (trickle="+i.trickle+")"),i.pc.oniceconnectionstatechange=function(e){i.pc&&a.iceState(i.pc.iceConnectionState)},i.pc.onicecandidate=function(n){if(null==n.candidate||"edge"===adapter.browserDetails.browser&&n.candidate.candidate.indexOf("endOfCandidates")>0)Janus.log("End of candidates."),i.iceDone=!0,!0===i.trickle?s(e,{completed:!0}):function(e,n){(n=n||{}).success="function"==typeof n.success?n.success:Janus.noop,n.error="function"==typeof n.error?n.error:Janus.noop;var t=U[e];if(null===t||void 0===t||null===t.webrtcStuff||void 0===t.webrtcStuff)return void Janus.warn("Invalid handle, not sending anything");var r=t.webrtcStuff;if(Janus.log("Sending offer/answer SDP..."),null===r.mySdp||void 0===r.mySdp)return void Janus.warn("Local SDP instance is invalid, not sending anything...");if(r.mySdp={type:r.pc.localDescription.type,sdp:r.pc.localDescription.sdp},r.sdpSent)return void Janus.log("Offer/Answer SDP already sent, not sending it again");!1===r.trickle&&(r.mySdp.trickle=!1);Janus.debug(n),r.sdpSent=!0,n.success(r.mySdp)}(e,r);else{var t={candidate:n.candidate.candidate,sdpMid:n.candidate.sdpMid,sdpMLineIndex:n.candidate.sdpMLineIndex};!0===i.trickle&&s(e,t)}},null!==o&&void 0!==o&&(Janus.log("Adding local stream"),i.pc.addStream(o),a.onlocalstream(o)),i.pc.onaddstream=function(e){Janus.log("Handling Remote Stream"),Janus.debug(e),i.remoteStream=e,a.onremotestream(e.stream)},function(e){if(Janus.debug("isDataEnabled:",e),"edge"==adapter.browserDetails.browser)return Janus.warn("Edge doesn't support data channels yet"),!1;return void 0!==e&&null!==e&&!0===e.data}(t)){Janus.log("Creating data channel");var d=function(){var e=null!==i.dataChannel?i.dataChannel.readyState:"null";Janus.log("State change on data channel: "+e),"open"===e&&a.ondataopen()};i.dataChannel=i.pc.createDataChannel("JanusDataChannel",{ordered:!1}),i.dataChannel.onmessage=function(e){Janus.log("Received message on data channel: "+e.data),a.ondata(e.data)},i.dataChannel.onopen=d,i.dataChannel.onclose=d,i.dataChannel.onerror=function(e){Janus.error("Got error on data channel:",e)}}null===n||void 0===n?p(e,t,r):("edge"===adapter.browserDetails.browser&&(n.sdp+="a=end-of-candidates\r\n"),i.pc.setRemoteDescription(new RTCSessionDescription(n),function(){Janus.log("Remote description accepted!"),g(e,t,r)},r.error))}function c(e,n){function t(t,r){s.consentDialog(!1),t?n.error({code:t.code,name:t.name,message:t.message}):d(e,o,a,n,r)}function r(e,n,t){Janus.log("Adding media constraint (screen capture)"),Janus.debug(e),navigator.mediaDevices.getUserMedia(e).then(function(e){t?navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(function(t){e.addTrack(t.getAudioTracks()[0]),n(null,e)}):n(null,e)}).catch(function(e){s.consentDialog(!1),n(e)})}(n=n||{}).success="function"==typeof n.success?n.success:Janus.noop,n.error="function"==typeof n.error?n.error:J;var o=n.jsep,a=n.media,s=U[e];if(null===s||void 0===s||null===s.webrtcStuff||void 0===s.webrtcStuff)return Janus.warn("Invalid handle"),void n.error("Invalid handle");var i=s.webrtcStuff;if(void 0!==i.pc&&null!==i.pc)return Janus.log("Updating existing media session"),void(null===o||void 0===o?p(e,a,n):("edge"===adapter.browserDetails.browser&&(o.sdp+="a=end-of-candidates\r\n"),i.pc.setRemoteDescription(new RTCSessionDescription(o),function(){Janus.log("Remote description accepted!"),g(e,a,n)},n.error)));if(null!==n.stream&&void 0!==n.stream){var u=n.stream;return Janus.log("MediaStream provided by the application"),Janus.debug(u),i.streamExternal=!0,void d(e,o,a,n,u)}if(i.trickle=function(e){return Janus.debug("isTrickleEnabled:",e),void 0===e||null===e||!0===e}(n.trickle),y(a)||_(a)){var l={mandatory:{},optional:[]};s.consentDialog(!0);var c=y(a);!0===c&&void 0!=a&&null!=a&&"object"==typeof a.audio&&(c=a.audio);var f=_(a);if(!0===f&&void 0!=a&&null!=a)if(a.video&&"screen"!=a.video&&"window"!=a.video){var v=0,m=0,h=0;if("lowres"===a.video)m=240,h=240,v=320;else if("lowres-16:9"===a.video)m=180,h=180,v=320;else if("hires"===a.video||"hires-16:9"===a.video){if(m=720,h=720,v=1280,navigator.mozGetUserMedia){(b=parseInt(window.navigator.userAgent.match(/Firefox\/(.*)/)[1],10))<38&&(Janus.warn(a.video+" unsupported, falling back to stdres (old Firefox)"),m=480,h=480,v=640)}}else"stdres"===a.video?(m=480,h=480,v=640):"stdres-16:9"===a.video?(m=360,h=360,v=640):(Janus.log("Default video setting ("+a.video+") is stdres 4:3"),m=480,h=480,v=640);if(Janus.log("Adding media constraint "+a.video),navigator.mozGetUserMedia){var b=parseInt(window.navigator.userAgent.match(/Firefox\/(.*)/)[1],10);f=b<38?{require:["height","width"],height:{max:h,min:m},width:{max:v,min:v}}:{height:{ideal:m},width:{ideal:v}}}else f={mandatory:{maxHeight:h,minHeight:m,maxWidth:v,minWidth:v},optional:[]};"object"==typeof a.video&&(f=a.video),Janus.debug(f)}else if("screen"===a.video||"window"===a.video){if(a.screenshareFrameRate||(a.screenshareFrameRate=3),"https:"!==window.location.protocol)return Janus.warn("Screen sharing only works on HTTPS, try the https:// version of this page"),s.consentDialog(!1),void n.error("Screen sharing only works on HTTPS, try the https:// version of this page");var w={};if("chrome"===adapter.browserDetails.browser){var S=adapter.browserDetails.version,I=33;if(window.navigator.userAgent.match("Linux")&&(I=35),S>=26&&S<=I)r(l={video:{mandatory:{googLeakyBucket:!0,maxWidth:window.screen.width,maxHeight:window.screen.height,minFrameRate:a.screenshareFrameRate,maxFrameRate:a.screenshareFrameRate,chromeMediaSource:"screen"}},audio:y(a)},t);else{var k=window.setTimeout(function(){return T=new Error("NavigatorUserMediaError"),T.name='The required Chrome extension is not installed: click <a href="#">here</a> to install it. (NOTE: this will need you to refresh the page)',s.consentDialog(!1),n.error(T)},1e3);w[k]=[t,null],window.postMessage({type:"janusGetScreen",id:k},"*")}}else if(window.navigator.userAgent.match("Firefox")){if(!(parseInt(window.navigator.userAgent.match(/Firefox\/(.*)/)[1],10)>=33)){var T=new Error("NavigatorUserMediaError");return T.name="Your version of Firefox does not support screen sharing, please install Firefox 33 (or more recent versions)",s.consentDialog(!1),void n.error(T)}r(l={video:{mozMediaSource:a.video,mediaSource:a.video},audio:y(a)},function(e,n){if(t(e,n),!e)var r=n.currentTime,o=window.setInterval(function(){n||window.clearInterval(o),n.currentTime==r&&(window.clearInterval(o),n.onended&&n.onended()),r=n.currentTime},500)})}return void window.addEventListener("message",function(e){if(e.origin==window.location.origin)if("janusGotScreen"==e.data.type&&w[e.data.id]){var t=w[e.data.id][0];if(delete w[e.data.id],""===e.data.sourceId){var o=new Error("NavigatorUserMediaError");o.name="You cancelled the request for permission, giving up...",s.consentDialog(!1),n.error(o)}else(l={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",maxWidth:window.screen.width,maxHeight:window.screen.height,minFrameRate:a.screenshareFrameRate,maxFrameRate:a.screenshareFrameRate},optional:[{googLeakyBucket:!0},{googTemporalLayeredScreencast:!0}]}}).video.mandatory.chromeMediaSourceId=e.data.sourceId,r(l,t,y(a))}else"janusGetScreenPending"==e.data.type&&window.clearTimeout(e.data.id)})}null!==a&&void 0!==a&&"screen"===a.video||navigator.mediaDevices.enumerateDevices().then(function(t){var r=t.some(function(e){return"audioinput"===e.kind}),i=t.some(function(e){return"videoinput"===e.kind}),u=y(a),l=_(a),p=function(e){return Janus.debug("isAudioSendRequired:",e),void 0!==e&&null!==e&&!1!==e.audio&&!1!==e.audioSend&&void 0!==e.failIfNoAudio&&null!==e.failIfNoAudio&&!0===e.failIfNoAudio}(a),g=function(e){return Janus.debug("isVideoSendRequired:",e),void 0!==e&&null!==e&&!1!==e.video&&!1!==e.videoSend&&void 0!==e.failIfNoVideo&&null!==e.failIfNoVideo&&!0===e.failIfNoVideo}(a);if(u||l||p||g){var v=!!u&&r,m=!!l&&i;if(!v&&!m)return s.consentDialog(!1),n.error("No capture device found"),!1;if(!v&&p)return s.consentDialog(!1),n.error("Audio capture is required, but no capture device found"),!1;if(!m&&g)return s.consentDialog(!1),n.error("Video capture is required, but no capture device found"),!1}navigator.mediaDevices.getUserMedia({audio:!!r&&c,video:!!i&&f}).then(function(t){s.consentDialog(!1),d(e,o,a,n,t)}).catch(function(e){s.consentDialog(!1),n.error({code:e.code,name:e.name,message:e.message})})}).catch(function(e){s.consentDialog(!1),n.error("enumerateDevices error",e)})}else d(e,o,a,n)}function f(e,n){(n=n||{}).success="function"==typeof n.success?n.success:Janus.noop,n.error="function"==typeof n.error?n.error:J;var t=n.jsep,r=U[e];if(null===r||void 0===r||null===r.webrtcStuff||void 0===r.webrtcStuff)return Janus.warn("Invalid handle"),void n.error("Invalid handle");var o=r.webrtcStuff;if(void 0!==t&&null!==t){if(null===o.pc)return Janus.warn("Wait, no PeerConnection?? if this is an answer, use createAnswer and not handleRemoteJsep"),void n.error("No PeerConnection: if this is an answer, use createAnswer and not handleRemoteJsep");"edge"===adapter.browserDetails.browser&&(t.sdp+="a=end-of-candidates\r\n"),o.pc.setRemoteDescription(new RTCSessionDescription(t),function(){Janus.log("Remote description accepted!"),n.success()},n.error)}else n.error("Invalid JSEP")}function p(e,n,t){(t=t||{}).success="function"==typeof t.success?t.success:Janus.noop,t.error="function"==typeof t.error?t.error:Janus.noop;var r=U[e];if(null===r||void 0===r||null===r.webrtcStuff||void 0===r.webrtcStuff)return Janus.warn("Invalid handle"),void t.error("Invalid handle");var o=r.webrtcStuff;Janus.log("Creating offer (iceDone="+o.iceDone+")");var a=null;a="firefox"==adapter.browserDetails.browser||"edge"==adapter.browserDetails.browser?{offerToReceiveAudio:S(n),offerToReceiveVideo:I(n)}:{mandatory:{OfferToReceiveAudio:S(n),OfferToReceiveVideo:I(n)}},Janus.debug(a),o.pc.createOffer(function(e){if(Janus.debug(e),null!==o.mySdp&&void 0!==o.mySdp||(Janus.log("Setting local description"),o.mySdp=e.sdp,o.pc.setLocalDescription(e)),o.iceDone||o.trickle)if(o.sdpSent)Janus.log("Offer already sent, not sending it again");else{Janus.log("Offer ready"),Janus.debug(t),o.sdpSent=!0;var n={type:e.type,sdp:e.sdp};t.success(n)}else Janus.log("Waiting for all candidates...")},t.error,a)}function g(e,n,t){(t=t||{}).success="function"==typeof t.success?t.success:Janus.noop,t.error="function"==typeof t.error?t.error:Janus.noop;var r=U[e];if(null===r||void 0===r||null===r.webrtcStuff||void 0===r.webrtcStuff)return Janus.warn("Invalid handle"),void t.error("Invalid handle");var o=r.webrtcStuff;Janus.log("Creating answer (iceDone="+o.iceDone+")");var a=null;a="firefox"==adapter.browserDetails.browser||"edge"==adapter.browserDetails.browser?{offerToReceiveAudio:S(n),offerToReceiveVideo:I(n)}:{mandatory:{OfferToReceiveAudio:S(n),OfferToReceiveVideo:I(n)}},Janus.debug(a),o.pc.createAnswer(function(e){if(Janus.debug(e),null!==o.mySdp&&void 0!==o.mySdp||(Janus.log("Setting local description"),o.mySdp=e.sdp,o.pc.setLocalDescription(e)),o.iceDone||o.trickle)if(o.sdpSent)Janus.log("Answer already sent, not sending it again");else{o.sdpSent=!0;var n={type:e.type,sdp:e.sdp};t.success(n)}else Janus.log("Waiting for all candidates...")},t.error,a)}function v(e){var n=U[e];if(null===n||void 0===n||null===n.webrtcStuff||void 0===n.webrtcStuff)return Janus.warn("Invalid handle"),0;var t=n.webrtcStuff;return t.pc.getStats&&"chrome"==adapter.browserDetails.browser?null===t.remoteStream||void 0===t.remoteStream?(Janus.warn("Remote stream unavailable"),0):null===t.volume.timer||void 0===t.volume.timer?(Janus.log("Starting volume monitor"),t.volume.timer=setInterval(function(){t.pc.getStats(function(e){for(var n=e.result(),r=0;r<n.length;r++){var o=n[r];"ssrc"==o.type&&o.stat("audioOutputLevel")&&(t.volume.value=o.stat("audioOutputLevel"))}})},200),0):t.volume.value:(Janus.log("Getting the remote volume unsupported by browser"),0)}function m(e,n){var t=U[e];if(null===t||void 0===t||null===t.webrtcStuff||void 0===t.webrtcStuff)return Janus.warn("Invalid handle"),!0;var r=t.webrtcStuff;return null===r.pc||void 0===r.pc?(Janus.warn("Invalid PeerConnection"),!0):void 0===r.myStream||null===r.myStream?(Janus.warn("Invalid local MediaStream"),!0):n?null===r.myStream.getVideoTracks()||void 0===r.myStream.getVideoTracks()||0===r.myStream.getVideoTracks().length?(Janus.warn("No video track"),!0):!r.myStream.getVideoTracks()[0].enabled:null===r.myStream.getAudioTracks()||void 0===r.myStream.getAudioTracks()||0===r.myStream.getAudioTracks().length?(Janus.warn("No audio track"),!0):!r.myStream.getAudioTracks()[0].enabled}function h(e,n,t){var r=U[e];if(null===r||void 0===r||null===r.webrtcStuff||void 0===r.webrtcStuff)return Janus.warn("Invalid handle"),!1;var o=r.webrtcStuff;return null===o.pc||void 0===o.pc?(Janus.warn("Invalid PeerConnection"),!1):void 0===o.myStream||null===o.myStream?(Janus.warn("Invalid local MediaStream"),!1):n?null===o.myStream.getVideoTracks()||void 0===o.myStream.getVideoTracks()||0===o.myStream.getVideoTracks().length?(Janus.warn("No video track"),!1):(o.myStream.getVideoTracks()[0].enabled=!t,!0):null===o.myStream.getAudioTracks()||void 0===o.myStream.getAudioTracks()||0===o.myStream.getAudioTracks().length?(Janus.warn("No audio track"),!1):(o.myStream.getAudioTracks()[0].enabled=!t,!0)}function b(e){var n=U[e];if(null===n||void 0===n||null===n.webrtcStuff||void 0===n.webrtcStuff)return Janus.warn("Invalid handle"),"Invalid handle";var t=n.webrtcStuff;if(null===t.pc||void 0===t.pc)return"Invalid PeerConnection";if(t.pc.getStats&&"chrome"==adapter.browserDetails.browser)return null===t.remoteStream||void 0===t.remoteStream?(Janus.warn("Remote stream unavailable"),"Remote stream unavailable"):null===t.bitrate.timer||void 0===t.bitrate.timer?(Janus.log("Starting bitrate timer (Chrome)"),t.bitrate.timer=setInterval(function(){t.pc.getStats(function(e){for(var n=e.result(),r=0;r<n.length;r++){var o=n[r];if("ssrc"==o.type&&o.stat("googFrameHeightReceived"))if(t.bitrate.bsnow=o.stat("bytesReceived"),t.bitrate.tsnow=o.timestamp,null===t.bitrate.bsbefore||null===t.bitrate.tsbefore)t.bitrate.bsbefore=t.bitrate.bsnow,t.bitrate.tsbefore=t.bitrate.tsnow;else{var a=Math.round(8*(t.bitrate.bsnow-t.bitrate.bsbefore)/(t.bitrate.tsnow-t.bitrate.tsbefore));t.bitrate.value=a+" kbits/sec",t.bitrate.bsbefore=t.bitrate.bsnow,t.bitrate.tsbefore=t.bitrate.tsnow}}})},1e3),"0 kbits/sec"):t.bitrate.value;if(t.pc.getStats&&"firefox"==adapter.browserDetails.browser){if(null===t.remoteStream||void 0===t.remoteStream||null===t.remoteStream.streams[0]||void 0===t.remoteStream.streams[0])return Janus.warn("Remote stream unavailable"),"Remote stream unavailable";var r=t.remoteStream.streams[0].getVideoTracks();return null===r||void 0===r||r.length<1?(Janus.warn("No video track"),"No video track"):null===t.bitrate.timer||void 0===t.bitrate.timer?(Janus.log("Starting bitrate timer (Firefox)"),t.bitrate.timer=setInterval(function(){var e=function(e){if(null!==e&&void 0!==e&&null!=e.inbound_rtp_video_1&&null!=e.inbound_rtp_video_1)if(t.bitrate.bsnow=e.inbound_rtp_video_1.bytesReceived,t.bitrate.tsnow=e.inbound_rtp_video_1.timestamp,null===t.bitrate.bsbefore||null===t.bitrate.tsbefore)t.bitrate.bsbefore=t.bitrate.bsnow,t.bitrate.tsbefore=t.bitrate.tsnow;else{var n=Math.round(8*(t.bitrate.bsnow-t.bitrate.bsbefore)/(t.bitrate.tsnow-t.bitrate.tsbefore));t.bitrate.value=n+" kbits/sec",t.bitrate.bsbefore=t.bitrate.bsnow,t.bitrate.tsbefore=t.bitrate.tsnow}else t.bitrate.value="Missing inbound_rtp_video_1"};t.pc.getStats(r[0],function(n){e(n)},e)},1e3),"0 kbits/sec"):t.bitrate.value}return Janus.warn("Getting the video bitrate unsupported by browser"),"Feature unsupported by browser"}function J(e){Janus.error("WebRTC error:",e)}function w(e,n){Janus.log("Cleaning WebRTC stuff");var t=U[e];if(null!==t&&void 0!==t){var r=t.webrtcStuff;if(null!==r&&void 0!==r){if(!0===n){var o={janus:"hangup",transaction:Janus.randomString(12)};null!==L&&void 0!==L&&(o.token=L),null!==V&&void 0!==V&&(o.apisecret=V),Janus.debug("Sending hangup request (handle="+e+"):"),Janus.debug(o),k?(o.session_id=F,o.handle_id=e,T.send(JSON.stringify(o))):Janus.ajax({type:"POST",url:O+"/"+F+"/"+e,withCredentials:M,cache:!1,contentType:"application/json",data:JSON.stringify(o),dataType:"json"})}r.remoteStream=null,r.volume.timer&&clearInterval(r.volume.timer),r.volume.value=null,r.bitrate.timer&&clearInterval(r.bitrate.timer),r.bitrate.timer=null,r.bitrate.bsnow=null,r.bitrate.bsbefore=null,r.bitrate.tsnow=null,r.bitrate.tsbefore=null,r.bitrate.value=null;try{r.streamExternal||null===r.myStream||void 0===r.myStream||(Janus.log("Stopping local stream"),r.myStream.stop())}catch(e){}try{if(!r.streamExternal&&null!==r.myStream&&void 0!==r.myStream){Janus.log("Stopping local stream tracks");var a=r.myStream.getTracks();for(var s in a){var i=a[s];Janus.log(i),null!==i&&void 0!==i&&i.stop()}}}catch(e){}r.streamExternal=!1,r.myStream=null;try{r.pc.close()}catch(e){}r.pc=null,r.mySdp=null,r.iceDone=!1,r.sdpSent=!1,r.dataChannel=null,r.dtmfSender=null}t.oncleanup()}}function y(e){return Janus.debug("isAudioSendEnabled:",e),void 0===e||null===e||!1!==e.audio&&(void 0===e.audioSend||null===e.audioSend||!0===e.audioSend)}function S(e){return Janus.debug("isAudioRecvEnabled:",e),void 0===e||null===e||!1!==e.audio&&(void 0===e.audioRecv||null===e.audioRecv||!0===e.audioRecv)}function _(e){return Janus.debug("isVideoSendEnabled:",e),void 0===e||null===e||!1!==e.video&&(void 0===e.videoSend||null===e.videoSend||!0===e.videoSend)}function I(e){return Janus.debug("isVideoRecvEnabled:",e),void 0===e||null===e||!1!==e.video&&(void 0===e.videoRecv||null===e.videoRecv||!0===e.videoRecv)}if(void 0===Janus.initDone)return e.error("Library not initialized"),{};if(!Janus.isWebrtcSupported())return e.error("WebRTC not supported by this browser"),{};if(Janus.log("Library initialized: "+Janus.initDone),e=e||{},e.success="function"==typeof e.success?e.success:Janus.noop,e.error="function"==typeof e.error?e.error:Janus.noop,e.destroyed="function"==typeof e.destroyed?e.destroyed:Janus.noop,null===e.server||void 0===e.server)return e.error("Invalid gateway url"),{};var k=!1,T=null,D={},C=null,j=null,R=0,O=e.server;Array.isArray(O)?(Janus.log("Multiple servers provided ("+O.length+"), will use the first that works"),O=null,j=e.server,Janus.debug(j)):0===O.indexOf("ws")?(k=!0,Janus.log("Using WebSockets to contact Janus: "+O)):(k=!1,Janus.log("Using REST API to contact Janus: "+O));var x=e.iceServers;void 0!==x&&null!==x||(x=[{urls:"stun:stun.l.google.com:19302"}]);var A=e.iceTransportPolicy,N=e.ipv6;void 0!==N&&null!==N||(N=!1);var M=!1;void 0!==e.withCredentials&&null!==e.withCredentials&&(M=!0===e.withCredentials);var E=null;void 0!==e.max_poll_events&&null!==e.max_poll_events&&(E=e.max_poll_events),E<1&&(E=1);var L=null;void 0!==e.token&&null!==e.token&&(L=e.token);var V=null;void 0!==e.apisecret&&null!==e.apisecret&&(V=e.apisecret),this.destroyOnUnload=!0,void 0!==e.destroyOnUnload&&null!==e.destroyOnUnload&&(this.destroyOnUnload=!0===e.destroyOnUnload);var P=!1,F=null,U={},q=this,G=0,H={};o(e),this.getServer=function(){return O},this.isConnected=function(){return P},this.getSessionId=function(){return F},this.destroy=function(n){!function(n){(n=n||{}).success="function"==typeof n.success?n.success:Janus.noop;var t=!0;if(void 0!==n.asyncRequest&&null!==n.asyncRequest&&(t=!0===n.asyncRequest),Janus.log("Destroying session "+F+" (async="+t+")"),!P)return Janus.warn("Is the gateway down? (connected=false)"),void n.success();if(void 0===F||null===F)return Janus.warn("No session to destroy"),n.success(),void e.destroyed();delete Janus.sessions[F];var r={janus:"destroy",transaction:Janus.randomString(12)};if(null!==L&&void 0!==L&&(r.token=L),null!==V&&void 0!==V&&(r.apisecret=V),k){r.session_id=F;var o=function(){for(var e in D)T.removeEventListener(e,D[e]);T.removeEventListener("message",a),T.removeEventListener("error",s),C&&clearTimeout(C)},a=function(t){var a=JSON.parse(t.data);a.session_id==r.session_id&&a.transaction==r.transaction&&(o(),n.success(),e.destroyed())},s=function(t){o(),n.error("Failed to destroy the gateway: Is the gateway down?"),e.destroyed()};return T.addEventListener("message",a),T.addEventListener("error",s),void T.send(JSON.stringify(r))}Janus.ajax({type:"POST",url:O+"/"+F,async:t,withCredentials:M,cache:!1,contentType:"application/json",data:JSON.stringify(r),success:function(t){Janus.log("Destroyed session:"),Janus.debug(t),F=null,P=!1,"success"!==t.janus&&Janus.error("Ooops: "+t.error.code+" "+t.error.reason),n.success(),e.destroyed()},error:function(t,r,o){Janus.error(r+": "+o),F=null,P=!1,n.success(),e.destroyed()},dataType:"json"})}(n)},this.attach=function(e){!function(e){if(e=e||{},e.success="function"==typeof e.success?e.success:Janus.noop,e.error="function"==typeof e.error?e.error:Janus.noop,e.consentDialog="function"==typeof e.consentDialog?e.consentDialog:Janus.noop,e.iceState="function"==typeof e.iceState?e.iceState:Janus.noop,e.mediaState="function"==typeof e.mediaState?e.mediaState:Janus.noop,e.webrtcState="function"==typeof e.webrtcState?e.webrtcState:Janus.noop,e.slowLink="function"==typeof e.slowLink?e.slowLink:Janus.noop,e.onmessage="function"==typeof e.onmessage?e.onmessage:Janus.noop,e.onlocalstream="function"==typeof e.onlocalstream?e.onlocalstream:Janus.noop,e.onremotestream="function"==typeof e.onremotestream?e.onremotestream:Janus.noop,e.ondata="function"==typeof e.ondata?e.ondata:Janus.noop,e.ondataopen="function"==typeof e.ondataopen?e.ondataopen:Janus.noop,e.oncleanup="function"==typeof e.oncleanup?e.oncleanup:Janus.noop,e.ondetached="function"==typeof e.ondetached?e.ondetached:Janus.noop,!P)return Janus.warn("Is the gateway down? (connected=false)"),void e.error("Is the gateway down? (connected=false)");var n=e.plugin;if(void 0===n||null===n)return Janus.error("Invalid plugin"),void e.error("Invalid plugin");var t=e.opaqueId,r=Janus.randomString(12),o={janus:"attach",plugin:n,opaque_id:t,transaction:r};if(null!==L&&void 0!==L&&(o.token=L),null!==V&&void 0!==V&&(o.apisecret=V),"chrome"!=adapter.browserDetails.browser&&"firefox"!=adapter.browserDetails.browser||(o["force-bundle"]=!0,o["force-rtcp-mux"]=!0),k)return H[r]=function(t){if(Janus.debug(t),"success"!==t.janus)return Janus.error("Ooops: "+t.error.code+" "+t.error.reason),void e.error("Ooops: "+t.error.code+" "+t.error.reason);var r=t.data.id;Janus.log("Created handle: "+r);var o={session:q,plugin:n,id:r,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,remoteStream:null,mySdp:null,pc:null,dataChannel:null,dtmfSender:null,trickle:!0,iceDone:!1,sdpSent:!1,volume:{value:null,timer:null},bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null}},getId:function(){return r},getPlugin:function(){return n},getVolume:function(){return v(r)},isAudioMuted:function(){return m(r,!1)},muteAudio:function(){return h(r,!1,!0)},unmuteAudio:function(){return h(r,!1,!1)},isVideoMuted:function(){return m(r,!0)},muteVideo:function(){return h(r,!0,!0)},unmuteVideo:function(){return h(r,!0,!1)},getBitrate:function(){return b(r)},send:function(e){a(r,e)},data:function(e){i(r,e)},dtmf:function(e){u(r,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){c(r,e)},createAnswer:function(e){c(r,e)},handleRemoteJsep:function(e){f(r,e)},onlocalstream:e.onlocalstream,onremotestream:e.onremotestream,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){w(r,!0===e)},detach:function(e){l(r,e)}};U[r]=o,e.success(o)},o.session_id=F,void T.send(JSON.stringify(o));Janus.ajax({type:"POST",url:O+"/"+F,withCredentials:M,cache:!1,contentType:"application/json",data:JSON.stringify(o),success:function(t){if(Janus.debug(t),"success"!==t.janus)return Janus.error("Ooops: "+t.error.code+" "+t.error.reason),void e.error("Ooops: "+t.error.code+" "+t.error.reason);var r=t.data.id;Janus.log("Created handle: "+r);var o={session:q,plugin:n,id:r,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,remoteStream:null,mySdp:null,pc:null,dataChannel:null,dtmfSender:null,trickle:!0,iceDone:!1,sdpSent:!1,volume:{value:null,timer:null},bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null}},getId:function(){return r},getPlugin:function(){return n},getVolume:function(){return v(r)},isAudioMuted:function(){return m(r,!1)},muteAudio:function(){return h(r,!1,!0)},unmuteAudio:function(){return h(r,!1,!1)},isVideoMuted:function(){return m(r,!0)},muteVideo:function(){return h(r,!0,!0)},unmuteVideo:function(){return h(r,!0,!1)},getBitrate:function(){return b(r)},send:function(e){a(r,e)},data:function(e){i(r,e)},dtmf:function(e){u(r,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){c(r,e)},createAnswer:function(e){c(r,e)},handleRemoteJsep:function(e){f(r,e)},onlocalstream:e.onlocalstream,onremotestream:e.onremotestream,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){w(r,!0===e)},detach:function(e){l(r,e)}};U[r]=o,e.success(o)},error:function(e,n,t){Janus.error(n+": "+t)},dataType:"json"})}(e)}}function Sip(e,n,t,r){this.spkVol=.5,this._info={},this._lib=null,this._sip=null,this._status=null,this._sipNumber=null,this._lcStream=null,this._callInfo=null,this._timer=null,this._failCount=0,this._isCalling=!1,this._isHangup=!1,this._eventHandlers={},this._init(e,n,t,r)}Janus.sessions={},Janus.extensionId="hapfgfdkleiggjjpfpenajgdnfckjpaj",Janus.isExtensionEnabled=function(){if(window.navigator.userAgent.match("Chrome")){var e=parseInt(window.navigator.userAgent.match(/Chrome\/(.*) /)[1],10),n=33;return window.navigator.userAgent.match("Linux")&&(n=35),e>=26&&e<=n||null!==document.getElementById("janus-extension-installed")}return!0},Janus.noop=function(){},Janus.init=function(e){if(e=e||{},e.callback="function"==typeof e.callback?e.callback:Janus.noop,!0===Janus.initDone)e.callback();else{if("undefined"!=typeof console&&void 0!==console.log||(console={log:function(){}}),Janus.trace=Janus.noop,Janus.debug=Janus.noop,Janus.vdebug=Janus.noop,Janus.log=Janus.noop,Janus.warn=Janus.noop,Janus.error=Janus.noop,!0===e.debug||"all"===e.debug)Janus.trace=console.trace.bind(console),Janus.debug=console.debug.bind(console),Janus.vdebug=console.debug.bind(console),Janus.log=console.log.bind(console),Janus.warn=console.warn.bind(console),Janus.error=console.error.bind(console);else if(Array.isArray(e.debug))for(var n in e.debug){var t=e.debug[n];switch(t){case"trace":Janus.trace=console.trace.bind(console);break;case"debug":Janus.debug=console.debug.bind(console);break;case"vdebug":Janus.vdebug=console.debug.bind(console);break;case"log":Janus.log=console.log.bind(console);break;case"warn":Janus.warn=console.warn.bind(console);break;case"error":Janus.error=console.error.bind(console);break;default:console.error("Unknown debugging option '"+t+"' (supported: 'trace', 'debug', 'vdebug', 'log', warn', 'error')")}}Janus.log("Initializing library"),Janus.listDevices=function(e,n){e="function"==typeof e?e:Janus.noop,null==n&&(n={audio:!0,video:!0}),navigator.mediaDevices?navigator.mediaDevices.getUserMedia(n).then(function(n){navigator.mediaDevices.enumerateDevices().then(function(t){Janus.debug(t),e(t);try{n.stop()}catch(e){}try{var r=n.getTracks();for(var o in r){var a=r[o];null!==a&&void 0!==a&&a.stop()}}catch(e){}})}).catch(function(n){Janus.error(n),e([])}):(Janus.warn("navigator.mediaDevices unavailable"),e([]))},Janus.attachMediaStream=function(e,n){if("chrome"===adapter.browserDetails.browser){adapter.browserDetails.version>=43?e.srcObject=n:void 0!==e.src?e.src=URL.createObjectURL(n):Janus.error("Error attaching stream to element")}else e.srcObject=n},Janus.reattachMediaStream=function(e,n){if("chrome"===adapter.browserDetails.browser){adapter.browserDetails.version>=43?e.srcObject=n.srcObject:void 0!==e.src&&(e.src=n.src)}else"safari"===adapter.browserDetails.browser||window.navigator.userAgent.match(/iPad/i)||window.navigator.userAgent.match(/iPhone/i)?e.src=n.src:e.srcObject=n.srcObject},Janus.ajax=function(e){if(null!==e&&void 0!==e){if(e.success="function"==typeof e.success?e.success:Janus.noop,e.error="function"==typeof e.error?e.error:Janus.noop,null===e.url||void 0===e.url)return Janus.error("Missing url",e.url),void e.error(null,-1,"Missing url");e.async=null===e.async||void 0===e.async||!0===e.async,Janus.log(e);var n=new XMLHttpRequest;n.open(e.type,e.url,e.async),null!==e.contentType&&void 0!==e.contentType&&n.setRequestHeader("Content-type",e.contentType),null!==e.withCredentials&&void 0!==e.withCredentials&&(n.withCredentials=e.withCredentials),e.async&&(n.onreadystatechange=function(){if(4==n.readyState)if(200===n.status)try{e.success(JSON.parse(n.responseText))}catch(t){e.error(n,n.status,"Could not parse response, error: "+t+", text: "+n.responseText)}else e.error(n,0!==n.status?n.status:"error","")});try{if(n.send(e.data),!e.async){if(200!==n.status)return void e.error(n,0!==n.status?n.status:"error","");try{e.success(JSON.parse(n.responseText))}catch(t){e.error(n,n.status,"Could not parse response, error: "+t+", text: "+n.responseText)}}}catch(t){e.error(n,"error","")}}};var r=window.onbeforeunload;window.onbeforeunload=function(){Janus.log("Closing window");for(var e in Janus.sessions)null!==Janus.sessions[e]&&void 0!==Janus.sessions[e]&&Janus.sessions[e].destroyOnUnload&&(Janus.log("Destroying session "+e),Janus.sessions[e].destroy({asyncRequest:!1}));r&&"function"==typeof r&&r()},Janus.initDone=!0,e.callback()}},Janus.isWebrtcSupported=function(){return void 0!==window.RTCPeerConnection&&null!==window.RTCPeerConnection&&void 0!==navigator.getUserMedia&&null!==navigator.getUserMedia},Janus.randomString=function(e){for(var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t="",r=0;r<e;r++){var o=Math.floor(Math.random()*n.length);t+=n.substring(o,o+1)}return t},Sip.prototype._init=function(e,n,t,r){if(!e||!n||!t)return setTimeout(this._libInit,6e4),this._trigger("sip.error"),!1;this._info.proxy=e,this._info.user=n,this._info.secret=t,this._info.uri=r,this._libInit()},Sip.prototype.on=function(e,n){e in this._eventHandlers||(this._eventHandlers[e]=[]),this._eventHandlers[e].push(n)},Sip.prototype.register=function(){var e={request:"register",proxy:"sip:"+this._info.proxy,username:"sip:"+this._info.user+"@"+this._info.proxy,secret:this._info.secret};console.log("sip do register"),this._info.registered=-1,this._sip.send({message:e})},Sip.prototype.call=function(e,n){var t=this;return!0===this._isCalling?("function"==typeof n&&n("0"),!1):this._sip&&null===this._callInfo&&-1!==this._info.registered?0===this._info.registered?this._failCount>4?(n("1"),!1):("function"==typeof n&&n("0"),!1):!!e&&(this._isCalling=!0,this._isHangup=!1,void this._sip.createOffer({media:{audio:!0,video:!1},success:function(n){var r={request:"call",uri:"sip:"+e+"@"+t._info.proxy};console.log("sip do call"),t._sip.send({message:r,jsep:n})},error:function(e){console.log("WebRTC error:sipCall"),t._trigger("sip.jespError",e),t._isCalling=!1}})):("function"==typeof n&&n("0"),!1)},Sip.prototype.dial=function(e){return!1!==this._isCalling&&(!(!this._sip||!e)&&void this._sip.dtmf({dtmf:{tones:e}}))},Sip.prototype.answer=function(){var e=this;if(!this._sip)return!1;this._sip.createAnswer({jsep:e.jsep,media:{audio:!0,video:!1},success:function(n){console.log("sip do answer"),e._sip.send({message:{request:"accept"},jsep:n})},error:function(n){console.log("WebRTC error:sipAnswer"),this._trigger("sip.jespError",n),e._sip.send({message:{request:"decline",code:480}})}})},Sip.prototype.hangup=function(){var e=this,n="",t={request:"hangup"};if(this._callInfo&&this._callInfo.phoneNumber&&(n=this._callInfo.phoneNumber),this._trigger("message.hangup",n),!this._sip)return!1;"incomingcall"===this._status?(console.log("sip do decline"),t.request="decline",this._sip.send({message:t})):(console.log("sip do hangup"),this._sip.send({message:t}),this._sip.hangup()),this._timer=setTimeout(function(){setTimeout(e._libInit,6e4),e._trigger("sip.destroy"),e._sip.detach(),e._sip=null,e._callInfo=null},15e3)},Sip.prototype.speakerSet=function(e){var n=document.getElementById("sipRemoteVideo");return null!==n&&("boolean"==typeof e&&void(n.muted=!e))},Sip.prototype.speakerLevelSet=function(e){var n=e,t=document.getElementById("sipRemoteVideo");return null!==t&&("number"==typeof e&&(n=e>1?1:e,n=e<0?0:e,this.spkVol=n,void(t.volume=n)))},Sip.prototype.micSet=function(e){var n=this._lcStream.getAudioTracks();return!!this._lcStream&&(!!n[0]&&("boolean"==typeof e&&void(n[0].enabled=!!e)))},Sip.prototype._trigger=function(e,n){var t;for(t in this._eventHandlers)e===t&&Array.isArray(this._eventHandlers[t])&&this._eventHandlers[t].forEach(function(e){"function"==typeof e&&e.call(null,n)})},Sip.prototype._libInit=function(){var e=this;if(this._lib)return this._sip&&0===this._info.registered?this.register():this._libAttachSip(),!0;Janus.init({debug:!1,callback:function(){console.log("Janus lib init..."),e._lib=new Janus({server:e._info.uri,success:function(){console.log("Janus lib connect."),e._libAttachSip()},error:function(){console.log("Janus lib Error!"),e._lib=null,e._sip=null,setTimeout(e._libInit,6e4),e._trigger("sip.error")},destroyed:function(){console.log("Janus lib Destroyed!"),e._lib=null,e._sip=null,setTimeout(e._libInit,6e4),e._trigger("sip.destroy")}})}})},Sip.prototype._libAttachSip=function(){var e=this;if(!this._lib)return!1;this._lib.attach({plugin:"janus.plugin.sip",success:function(n){console.log("sip attach success"),e._failCount=0,e._isCalling=!1,e._sip=n,e.register()},error:function(){console.log("sip attach error")},consentDialog:function(e){console.log("sip on consentDialog : "+e)},onmessage:function(n,t){e._sipMessageHandler(n,t)},onlocalstream:function(n){console.log("sip on localStream"),e._lcStream=n},onremotestream:function(n){var t=document.getElementById("sipRemoteVideo");console.log("sip on remoteStream"),null===t&&(document.body.insertAdjacentHTML("beforeend",'<video id="sipRemoteVideo" autoplay style="display:none"></video>'),(t=document.getElementById("sipRemoteVideo")).volume=e.spkVol),attachMediaStream(t,n)},oncleanup:function(){var n=document.getElementById("sipRemoteVideo");null!==n&&document.body.removeChild(n),e._lcStream=null,console.log("sip on cleanup")},detached:function(){console.log("sip detached"),e._sip=null,setTimeout(e._libInit,6e4),e._trigger("sip.destroy")},ondataopen:function(){console.log("sip on ondataopen")},ondata:function(){console.log("sip on ondata")}})},Sip.prototype._sipMessageHandler=function(e,n){var t,r="";if("error"in e)return console.log("sip msg error : "+e.error),!1;switch("result"in e&&"event"in e.result&&(r=e.result.event),this._status=r,console.log("sip onMsg event : "+r),r){case"registered":if(this._failCount=0,this._isCalling=!1,1===this._info.registered)return!0;this._info.registered=1,this._trigger("message.registered");break;case"registration_failed":this._failCount+=1,this._info.registered=0,setTimeout(this._libInit,15e3),this._trigger("message.registration_failed");break;case"calling":this._trigger("message.calling");break;case"incomingcall":this._isCalling=!0,this._isHangup=!1,this.jsep=n,this._sipNumber=e.result.username,t=this._getNumber(this._sipNumber),this._trigger("message.incomingcall",t);break;case"accepted":null!==n&&void 0!==n&&this._sip.handleRemoteJsep({jsep:n,error:this.hangup}),"username"in e.result&&(this._sipNumber=e.result.username),t=this._getNumber(this._sipNumber),this._trigger("message.accepted",t);break;case"hangup":clearTimeout(this._timer),this._sip.hangup(),t="",this._callInfo&&this._callInfo.phoneNumber&&(t=this._callInfo.phoneNumber),this._trigger("message.hangup",t),this._isCalling=!1}this._callInfoSet()},Sip.prototype._callInfoSet=function(){var e=new Date;switch(this._status){case"calling":this._callInfo={callType:"OUTGOING",callDayTime:e.yyyymmddhhmmss(),callDuration:0};break;case"incomingcall":this._callInfo={name:this._getNumber(this._sipNumber),phoneNumber:this._getNumber(this._sipNumber),callType:"incomingcall",callDayTime:e.yyyymmddhhmmss(),callDuration:0};break;case"accepted":this._callInfo.callDuration=e.getTime(),this._callInfo.name=this._getNumber(this._sipNumber),this._callInfo.phoneNumber=this._getNumber(this._sipNumber),"incomingcall"===this._callInfo.callType&&(this._callInfo.callType="INCOMING");break;case"declining":this._callInfo.callType="INCOMING";break;case"hangup":"OUTGOING"!==this._callInfo.callType&&"INCOMING"!==this._callInfo.callType&&(this._callInfo.callType="MISSED"),0!==this._callInfo.callDuration&&(this._callInfo.callDuration=parseInt((e.getTime()-this._callInfo.callDuration)/1e3,10)),this._callInfo&&this._callInfo.name&&(this._callInfo._cate="callRecord",this._trigger("sip.saveCallInfo",this._callInfo)),this._callInfo=null}},Sip.prototype._getNumber=function(e){return e?e.substring(e.indexOf("sip:")+4,e.indexOf("@")):"unknown"};